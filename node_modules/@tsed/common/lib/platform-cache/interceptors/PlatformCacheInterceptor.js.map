{"version":3,"file":"PlatformCacheInterceptor.js","sourceRoot":"","sources":["../../../src/platform-cache/interceptors/PlatformCacheInterceptor.ts"],"names":[],"mappings":"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","sourcesContent":["import {isClass, isString, nameOf, Store} from \"@tsed/core\";\nimport {Inject, Interceptor, InterceptorContext, InterceptorMethods, InterceptorNext} from \"@tsed/di\";\nimport {deserialize, serialize} from \"@tsed/json-mapper\";\nimport {JsonEntityStore} from \"@tsed/schema\";\nimport {IncomingMessage, ServerResponse} from \"http\";\nimport {PlatformContext} from \"../../platform/domain/PlatformContext\";\nimport {PlatformCachedObject} from \"../interfaces/PlatformCachedObject\";\nimport {PlatformCacheOptions} from \"../interfaces/PlatformCacheOptions\";\nimport {PlatformCache} from \"../services/PlatformCache\";\n\nconst cleanHeaders = (headers: Record<string, unknown>) => {\n  return Object.entries(headers)\n    .filter(([key]) => ![\"content-length\", \"x-request-id\", \"cache-control\"].includes(key))\n    .reduce((headers, [key, value]) => {\n      return {\n        ...headers,\n        [key]: value\n      };\n    }, {});\n};\n\n/**\n * @platform\n */\n@Interceptor()\nexport class PlatformCacheInterceptor implements InterceptorMethods {\n  @Inject()\n  protected cache: PlatformCache;\n\n  async intercept(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    if (this.cache.disabled()) {\n      return next();\n    }\n\n    if (!this.isEndpoint(context)) {\n      return this.cacheMethod(context, next);\n    }\n\n    return this.cacheResponse(context, next);\n  }\n\n  protected getArgs(context: InterceptorContext<unknown, PlatformCacheOptions>) {\n    return context.args.reduce((args, arg) => {\n      if (arg instanceof PlatformContext || arg instanceof IncomingMessage || arg instanceof ServerResponse) {\n        return args;\n      }\n\n      if (isClass(arg)) {\n        return args.concat(serialize(arg));\n      }\n\n      return args.concat(arg);\n    }, []);\n  }\n\n  protected getOptions(context: InterceptorContext<any, PlatformCacheOptions>) {\n    const {ttl, type, collectionType, key: k = this.cache.defaultKeyResolver()} = context.options || {};\n\n    const args = this.getArgs(context);\n    const keyArgs = isString(k) ? k : k(args);\n\n    return {ttl, type, args, collectionType, keyArgs};\n  }\n\n  protected isEndpoint({target, propertyKey}: InterceptorContext<any, PlatformCacheOptions>) {\n    return Store.fromMethod(target, propertyKey).has(JsonEntityStore);\n  }\n\n  protected async cacheMethod(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    const {ttl, type, collectionType, keyArgs, args} = this.getOptions(context);\n    const key = [nameOf(context.target), context.propertyKey, keyArgs].join(\":\");\n\n    const cachedObject = await this.cache.get<PlatformCachedObject>(key);\n\n    if (cachedObject) {\n      const {data} = cachedObject;\n\n      return deserialize(JSON.parse(data), {collectionType, type});\n    }\n\n    const result = await next();\n    const calculatedTtl = this.cache.ttl(result, ttl);\n\n    await this.cache.set<PlatformCachedObject>(\n      key,\n      {\n        ttl: calculatedTtl,\n        args,\n        data: JSON.stringify(serialize(result, {type, collectionType}))\n      },\n      {\n        ttl: calculatedTtl\n      }\n    );\n\n    return result;\n  }\n\n  protected async cacheResponse(context: InterceptorContext<any, PlatformCacheOptions>, next: InterceptorNext) {\n    const $ctx: PlatformContext = context.args[context.args.length - 1];\n    const {request, response} = $ctx;\n\n    if (request.method !== \"GET\") {\n      return next();\n    }\n\n    const {ttl, args, keyArgs} = this.getOptions(context);\n\n    const key = [request.method, request.url, keyArgs].join(\":\");\n\n    const cachedObject = await this.cache.get<PlatformCachedObject>(key);\n\n    if (cachedObject && !(response.get(\"cache-control\") === \"no-cache\")) {\n      return this.sendResponse(cachedObject, $ctx);\n    }\n\n    const result = await next();\n\n    const calculatedTtl = this.cache.ttl(result, ttl);\n    const expires = calculatedTtl + Date.now() / 1000;\n    $ctx.response.setHeaders({\n      \"cache-control\": `max-age=${calculatedTtl}`\n    });\n\n    // cache final response with his headers and body\n    response.onEnd(async () => {\n      const data = JSON.stringify(response.getBody());\n      const headers = cleanHeaders(response.getHeaders());\n\n      await this.cache.set<PlatformCachedObject>(\n        key,\n        {\n          ttl: calculatedTtl,\n          args,\n          data,\n          expires,\n          headers\n        },\n        {\n          ttl: calculatedTtl\n        }\n      );\n    });\n\n    return result;\n  }\n\n  protected sendResponse(cachedObject: PlatformCachedObject, $ctx: PlatformContext) {\n    const {headers, ttl} = cachedObject;\n    const {request, response} = $ctx;\n\n    const requestEtag = request.get(\"if-none-match\");\n\n    if (requestEtag && headers.etag === requestEtag) {\n      response.status(304).setHeaders(headers).body(undefined);\n\n      return undefined;\n    }\n\n    const data = JSON.parse(cachedObject.data);\n\n    $ctx.response\n      .setHeaders({\n        ...headers,\n        \"x-cached\": \"true\",\n        \"cache-control\": `max-age=${ttl}`\n      })\n      .body(data);\n\n    return data;\n  }\n}\n"]}