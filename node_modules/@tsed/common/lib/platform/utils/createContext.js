"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createContext = void 0;
const PlatformContext_1 = require("../domain/PlatformContext");
const uuidv4 = require("uuid").v4;
const defaultReqIdBuilder = (req) => req.get("x-request-id") || uuidv4().replace(/-/gi, "");
/**
 * Create the TsED context to wrap request, response, injector, etc...
 * @param injector
 * @param request
 * @param response
 * @ignore
 */
async function createContext(injector, request, response) {
    const { level, ignoreUrlPatterns, maxStackSize, reqIdBuilder = defaultReqIdBuilder } = injector.settings.logger;
    const req = request.getRequest();
    const id = reqIdBuilder(req);
    const ctx = new PlatformContext_1.PlatformContext({
        id,
        logger: injector.logger,
        url: request.url,
        ignoreUrlPatterns,
        level,
        maxStackSize,
        injector,
        response,
        request
    });
    req.$ctx = ctx;
    response.setHeader("x-request-id", id);
    response.onEnd(async () => {
        await ctx.emit("$onResponse", ctx);
        await ctx.destroy();
        delete req.$ctx;
    });
    await ctx.emit("$onRequest", ctx);
    return ctx;
}
exports.createContext = createContext;
//# sourceMappingURL=createContext.js.map